<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>CRM Pro</title>
<link rel="manifest" href="manifest.json">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0f1e;
    --bg2: #111827;
    --bg3: #1e293b;
    --border: rgba(255,255,255,0.07);
    --text: #f1f5f9;
    --text2: #94a3b8;
    --text3: #475569;
    --accent: #6366f1;
    --accent2: #818cf8;
    --green: #10b981;
    --yellow: #f59e0b;
    --red: #ef4444;
    --blue: #3b82f6;
    --purple: #a855f7;
    --radius: 12px;
    --shadow: 0 4px 24px rgba(0,0,0,0.4);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    overflow: hidden;
  }

  /* ===== SIDEBAR ===== */
  .sidebar {
    width: 64px;
    background: var(--bg2);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px 0;
    gap: 4px;
    flex-shrink: 0;
    z-index: 100;
  }

  .sidebar-logo {
    width: 38px;
    height: 38px;
    background: var(--accent);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    margin-bottom: 16px;
  }

  .nav-item {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--text3);
    font-size: 20px;
    transition: all 0.15s;
    position: relative;
  }

  .nav-item:hover { background: var(--bg3); color: var(--text2); }
  .nav-item.active { background: rgba(99,102,241,0.15); color: var(--accent2); }

  .nav-item .tooltip {
    position: absolute;
    left: 52px;
    background: var(--bg3);
    color: var(--text);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    border: 1px solid var(--border);
  }

  .nav-item:hover .tooltip { opacity: 1; }

  /* ===== MAIN ===== */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .topbar {
    height: 56px;
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 12px;
    flex-shrink: 0;
  }

  .topbar h1 { font-size: 16px; font-weight: 600; flex: 1; }

  .btn {
    padding: 7px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.15s;
  }

  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: var(--accent2); }
  .btn-ghost { background: transparent; color: var(--text2); border: 1px solid var(--border); }
  .btn-ghost:hover { background: var(--bg3); }
  .btn-sm { padding: 4px 10px; font-size: 12px; }
  .btn-danger { background: rgba(239,68,68,0.15); color: var(--red); border: 1px solid rgba(239,68,68,0.3); }

  .content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }

  /* ===== PAGES ===== */
  .page { display: none; }
  .page.active { display: block; }

  /* ===== DASHBOARD ===== */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
  }

  .stat-label { font-size: 12px; color: var(--text3); margin-bottom: 6px; }
  .stat-value { font-size: 28px; font-weight: 600; font-family: 'DM Mono', monospace; }
  .stat-sub { font-size: 12px; color: var(--text3); margin-top: 4px; }
  .stat-green { color: var(--green); }
  .stat-yellow { color: var(--yellow); }
  .stat-blue { color: var(--blue); }
  .stat-purple { color: var(--purple); }

  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  @media (max-width: 768px) {
    .dashboard-grid { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: 1fr 1fr; }
  }

  .card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
  }

  .card-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text2);
    margin-bottom: 14px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Funnel */
  .funnel { display: flex; flex-direction: column; gap: 8px; }
  .funnel-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
  }
  .funnel-bar-wrap {
    flex: 1;
    height: 20px;
    background: var(--bg3);
    border-radius: 4px;
    overflow: hidden;
  }
  .funnel-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.6s ease;
  }
  .funnel-label { width: 80px; color: var(--text2); }
  .funnel-count { width: 30px; text-align: right; color: var(--text3); font-family: 'DM Mono', monospace; font-size: 12px; }

  /* Task list */
  .task-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .task-item:last-child { border-bottom: none; }
  .task-check {
    width: 16px; height: 16px;
    border-radius: 4px;
    border: 1.5px solid var(--text3);
    cursor: pointer;
    flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px;
    color: transparent;
    transition: all 0.15s;
  }
  .task-check.done { background: var(--green); border-color: var(--green); color: white; }
  .task-text { flex: 1; }
  .task-text.done { text-decoration: line-through; color: var(--text3); }
  .task-due { font-size: 11px; color: var(--text3); }
  .task-due.overdue { color: var(--red); }

  /* Activity feed */
  .activity-item {
    display: flex;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
  }
  .activity-item:last-child { border-bottom: none; }
  .activity-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--accent);
    margin-top: 4px;
    flex-shrink: 0;
  }
  .activity-text { color: var(--text2); line-height: 1.5; }
  .activity-time { color: var(--text3); margin-top: 2px; }

  /* ===== TABLE ===== */
  .search-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 14px;
    align-items: center;
  }

  .search-input {
    flex: 1;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    outline: none;
    transition: border-color 0.15s;
  }
  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--text3); }

  .filter-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 14px;
    background: var(--bg3);
    padding: 3px;
    border-radius: 8px;
    width: fit-content;
  }

  .filter-tab {
    padding: 5px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    color: var(--text3);
    transition: all 0.15s;
  }
  .filter-tab.active { background: var(--bg2); color: var(--text); }

  .table-wrap {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th {
    padding: 10px 14px;
    text-align: left;
    font-size: 11px;
    font-weight: 600;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--border);
    background: var(--bg3);
  }
  td {
    padding: 11px 14px;
    border-bottom: 1px solid var(--border);
    color: var(--text2);
    vertical-align: middle;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(255,255,255,0.02); }

  .badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 500;
  }
  .badge-blue { background: rgba(59,130,246,0.15); color: var(--blue); }
  .badge-green { background: rgba(16,185,129,0.15); color: var(--green); }
  .badge-yellow { background: rgba(245,158,11,0.15); color: var(--yellow); }
  .badge-red { background: rgba(239,68,68,0.15); color: var(--red); }
  .badge-purple { background: rgba(168,85,247,0.15); color: var(--purple); }
  .badge-gray { background: rgba(148,163,184,0.1); color: var(--text3); }

  .link-text { color: var(--accent2); cursor: pointer; }
  .link-text:hover { text-decoration: underline; }

  /* ===== KANBAN ===== */
  .kanban {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding-bottom: 12px;
  }

  .kanban-col {
    min-width: 220px;
    max-width: 220px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px;
    flex-shrink: 0;
  }

  .kanban-col-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--text2);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .kanban-col-count {
    background: var(--bg3);
    color: var(--text3);
    padding: 1px 6px;
    border-radius: 10px;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
  }

  .deal-card {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .deal-card:hover { border-color: var(--accent); transform: translateY(-1px); }
  .deal-name { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
  .deal-customer { font-size: 11px; color: var(--text3); margin-bottom: 6px; }
  .deal-amount { font-size: 14px; font-weight: 600; font-family: 'DM Mono', monospace; color: var(--text); }
  .deal-meta { display: flex; justify-content: space-between; margin-top: 6px; font-size: 11px; color: var(--text3); }

  /* ===== MODAL ===== */
  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.show { display: flex; }

  .modal {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    width: 90%;
    max-width: 480px;
    max-height: 85vh;
    overflow-y: auto;
    animation: slideUp 0.2s ease;
  }

  @keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .modal-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .modal-close {
    width: 28px; height: 28px;
    border-radius: 6px;
    background: var(--bg3);
    border: none;
    color: var(--text3);
    cursor: pointer;
    font-size: 16px;
    display: flex; align-items: center; justify-content: center;
  }
  .modal-close:hover { color: var(--text); }

  .form-group { margin-bottom: 14px; }
  .form-label { font-size: 12px; color: var(--text3); margin-bottom: 5px; display: block; }

  .form-input, .form-select, .form-textarea {
    width: 100%;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    outline: none;
    transition: border-color 0.15s;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); }
  .form-textarea { resize: vertical; min-height: 80px; }
  .form-select option { background: var(--bg2); }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .modal-footer { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }

  /* ===== DETAIL PANEL ===== */
  .detail-overlay {
    display: none;
    position: fixed; inset: 0;
    z-index: 900;
  }
  .detail-overlay.show { display: block; }

  .detail-panel {
    position: fixed;
    top: 0; right: 0; bottom: 0;
    width: min(480px, 100%);
    background: var(--bg2);
    border-left: 1px solid var(--border);
    overflow-y: auto;
    animation: slideIn 0.2s ease;
    z-index: 901;
  }

  @keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
  }

  .detail-bg {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(2px);
    z-index: 900;
  }

  .detail-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .detail-avatar {
    width: 44px; height: 44px;
    border-radius: 12px;
    background: var(--accent);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }

  .detail-name { font-size: 16px; font-weight: 600; }
  .detail-sub { font-size: 12px; color: var(--text3); margin-top: 2px; }
  .detail-close { margin-left: auto; }

  .detail-body { padding: 16px 20px; }
  .detail-section { margin-bottom: 20px; }
  .detail-section-title {
    font-size: 11px;
    font-weight: 600;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 10px;
  }
  .detail-field { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; border-bottom: 1px solid var(--border); }
  .detail-field:last-child { border-bottom: none; }
  .detail-field-label { color: var(--text3); }
  .detail-field-value { color: var(--text); text-align: right; }

  /* ===== EMPTY STATE ===== */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text3);
  }
  .empty-state .emoji { font-size: 40px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; }

  /* ===== LOGIN SCREEN ===== */
  #login-screen {
    display: none;
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  #login-screen.show { display: flex; }

  .login-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 40px;
    width: 90%;
    max-width: 360px;
    text-align: center;
    animation: slideUp 0.3s ease;
  }

  .login-logo {
    width: 56px; height: 56px;
    background: var(--accent);
    border-radius: 16px;
    display: flex; align-items: center; justify-content: center;
    font-size: 28px;
    margin: 0 auto 20px;
  }

  .login-title { font-size: 22px; font-weight: 600; margin-bottom: 6px; }
  .login-sub { font-size: 13px; color: var(--text3); margin-bottom: 28px; }

  .login-error {
    background: rgba(239,68,68,0.1);
    border: 1px solid rgba(239,68,68,0.3);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 12px;
    color: var(--red);
    margin-top: 14px;
    display: none;
  }

  .login-domain-info {
    font-size: 11px;
    color: var(--text3);
    margin-top: 16px;
    padding: 8px;
    background: var(--bg3);
    border-radius: 8px;
  }

  /* User avatar in topbar */
  .user-avatar {
    width: 30px; height: 30px;
    border-radius: 50%;
    background: var(--accent);
    display: flex; align-items: center; justify-content: center;
    font-size: 13px;
    cursor: pointer;
    border: none;
    color: white;
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    position: relative;
  }

  .user-menu {
    position: absolute;
    top: 40px; right: 0;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px;
    min-width: 180px;
    z-index: 200;
    display: none;
    box-shadow: var(--shadow);
  }
  .user-menu.show { display: block; }
  .user-menu-name { font-size: 13px; padding: 4px 8px; margin-bottom: 4px; }
  .user-menu-email { font-size: 11px; color: var(--text3); padding: 0 8px 8px; border-bottom: 1px solid var(--border); }
  .user-menu-item {
    padding: 7px 8px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    color: var(--text2);
    margin-top: 4px;
  }
  .user-menu-item:hover { background: var(--bg3); }

  /* Config banner */
  .config-banner {
    background: rgba(245,158,11,0.1);
    border: 1px solid rgba(245,158,11,0.3);
    border-radius: 10px;
    padding: 12px 16px;
    font-size: 13px;
    color: var(--yellow);
    margin-bottom: 16px;
    display: none;
  }
  .config-banner.show { display: block; }

  /* ===== SCROLLBAR ===== */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--bg3); border-radius: 3px; }

  /* ===== MOBILE ===== */
  @media (max-width: 640px) {
    .sidebar { width: 50px; }
    .form-row { grid-template-columns: 1fr; }
    th.hide-mobile, td.hide-mobile { display: none; }
    .content { padding: 12px; }
  }

  /* ===== GAS CONFIG ===== */
  .config-section {
    background: rgba(99,102,241,0.08);
    border: 1px solid rgba(99,102,241,0.2);
    border-radius: 10px;
    padding: 14px;
    margin-bottom: 16px;
    font-size: 13px;
  }
  .config-section p { color: var(--text2); margin-bottom: 8px; }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen" class="show">
  <div class="login-card">
    <div class="login-logo">ğŸ¯</div>
    <div class="login-title">CRM Pro</div>
    <div class="login-sub">ç¤¾å†…CRMã‚·ã‚¹ãƒ†ãƒ </div>

    <div id="google-signin-btn"></div>

    <div class="login-error" id="login-error">
      âš ï¸ ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚ä¼šç¤¾ã®Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
    </div>
    <div class="login-domain-info" id="login-domain-info">
      è¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼šè¨­å®šç”»é¢ã§è¨­å®šã—ã¦ãã ã•ã„
    </div>
  </div>
</div>

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="sidebar-logo">ğŸ¯</div>
  <div class="nav-item active" onclick="showPage('dashboard')" data-page="dashboard">
    ğŸ“Š<span class="tooltip">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
  </div>
  <div class="nav-item" onclick="showPage('contacts')" data-page="contacts">
    ğŸ‘¥<span class="tooltip">é¡§å®¢ç®¡ç†</span>
  </div>
  <div class="nav-item" onclick="showPage('deals')" data-page="deals">
    ğŸ’¼<span class="tooltip">å•†è«‡ç®¡ç†</span>
  </div>
  <div class="nav-item" onclick="showPage('tasks')" data-page="tasks">
    âœ…<span class="tooltip">ã‚¿ã‚¹ã‚¯</span>
  </div>
  <div class="nav-item" onclick="showPage('activities')" data-page="activities">
    ğŸ“‹<span class="tooltip">æ´»å‹•å±¥æ­´</span>
  </div>
  <div style="flex:1"></div>
  <div class="nav-item" onclick="showPage('settings')" data-page="settings">
    âš™ï¸<span class="tooltip">è¨­å®š</span>
  </div>
</nav>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <h1 id="page-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <div id="topbar-actions"></div>
    <div style="position:relative">
      <button class="user-avatar" id="user-avatar-btn" onclick="toggleUserMenu()">?</button>
      <div class="user-menu" id="user-menu">
        <div class="user-menu-name" id="user-menu-name">â€”</div>
        <div class="user-menu-email" id="user-menu-email">â€”</div>
        <div class="user-menu-item" onclick="logout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div>
      </div>
    </div>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">é¡§å®¢æ•°</div>
          <div class="stat-value stat-blue" id="stat-contacts">â€”</div>
          <div class="stat-sub">ç™»éŒ²æ¸ˆã¿é¡§å®¢</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">é€²è¡Œä¸­å•†è«‡</div>
          <div class="stat-value stat-purple" id="stat-deals">â€”</div>
          <div class="stat-sub">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ä»Šæœˆå£²ä¸Šäºˆæ¸¬</div>
          <div class="stat-value stat-green" id="stat-revenue">â€”</div>
          <div class="stat-sub">å—æ³¨è¦‹è¾¼ã¿åˆè¨ˆ</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æœªå®Œäº†ã‚¿ã‚¹ã‚¯</div>
          <div class="stat-value stat-yellow" id="stat-tasks">â€”</div>
          <div class="stat-sub">æœŸé™ç®¡ç†</div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="card">
          <div class="card-title">å•†è«‡ãƒ•ã‚¡ãƒãƒ«</div>
          <div class="funnel" id="funnel-chart"></div>
        </div>
        <div class="card">
          <div class="card-title">ç›´è¿‘ã®ã‚¿ã‚¹ã‚¯</div>
          <div id="dashboard-tasks"></div>
        </div>
        <div class="card" style="grid-column: 1 / -1">
          <div class="card-title">æœ€è¿‘ã®æ´»å‹•</div>
          <div id="dashboard-activities"></div>
        </div>
      </div>
    </div>

    <!-- CONTACTS -->
    <div class="page" id="page-contacts">
      <div class="search-bar">
        <input class="search-input" id="contact-search" placeholder="åå‰ãƒ»ä¼šç¤¾åãƒ»ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢..." oninput="filterContacts()">
      </div>
      <div class="filter-tabs">
        <div class="filter-tab active" onclick="setContactFilter('all', this)">ã™ã¹ã¦</div>
        <div class="filter-tab" onclick="setContactFilter('btob', this)">BtoBï¼ˆæ³•äººï¼‰</div>
        <div class="filter-tab" onclick="setContactFilter('btoc', this)">BtoCï¼ˆå€‹äººï¼‰</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>åå‰</th>
              <th>ç¨®åˆ¥</th>
              <th class="hide-mobile">ä¼šç¤¾å</th>
              <th class="hide-mobile">ãƒ¡ãƒ¼ãƒ«</th>
              <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="contacts-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- DEALS -->
    <div class="page" id="page-deals">
      <div class="kanban" id="kanban-board"></div>
    </div>

    <!-- TASKS -->
    <div class="page" id="page-tasks">
      <div class="search-bar">
        <input class="search-input" id="task-search" placeholder="ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢..." oninput="filterTasks()">
      </div>
      <div class="filter-tabs">
        <div class="filter-tab active" onclick="setTaskFilter('all', this)">ã™ã¹ã¦</div>
        <div class="filter-tab" onclick="setTaskFilter('pending', this)">æœªå®Œäº†</div>
        <div class="filter-tab" onclick="setTaskFilter('done', this)">å®Œäº†æ¸ˆã¿</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th width="30"></th>
              <th>ã‚¿ã‚¹ã‚¯å</th>
              <th class="hide-mobile">é–¢é€£é¡§å®¢</th>
              <th>æœŸé™</th>
              <th>å„ªå…ˆåº¦</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tasks-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- ACTIVITIES -->
    <div class="page" id="page-activities">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>æ—¥æ™‚</th>
              <th>ç¨®åˆ¥</th>
              <th>é¡§å®¢</th>
              <th class="hide-mobile">å†…å®¹</th>
              <th class="hide-mobile">æ‹…å½“</th>
            </tr>
          </thead>
          <tbody id="activities-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- SETTINGS -->
    <div class="page" id="page-settings">
      <div class="config-section">
        <p>âš ï¸ GASã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚è¨­å®šå¾Œã€å®Ÿéš›ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨ãƒ‡ãƒ¼ã‚¿ãŒé€£æºã•ã‚Œã¾ã™ã€‚</p>
        <div class="form-group">
          <label class="form-label">GAS Webã‚¢ãƒ—ãƒªURL</label>
          <input class="form-input" id="gas-url" placeholder="https://script.google.com/macros/s/xxxxx/exec" value="">
        </div>
        <button class="btn btn-primary" onclick="saveGasUrl()">URLã‚’ä¿å­˜</button>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="card-title">ğŸ” Googleèªè¨¼è¨­å®š</div>
        <div class="form-group" style="margin-top:12px">
          <label class="form-label">Google OAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID</label>
          <input class="form-input" id="google-client-id" placeholder="xxxxx.apps.googleusercontent.com">
        </div>
        <div class="form-group">
          <label class="form-label">è¨±å¯ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆè‡ªç¤¾ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰</label>
          <input class="form-input" id="allowed-domain" placeholder="yourcompany.com">
          <div style="font-size:11px;color:var(--text3);margin-top:4px">ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ã«ãªã‚Šã¾ã™</div>
        </div>
        <button class="btn btn-primary" onclick="saveAuthConfig()">èªè¨¼è¨­å®šã‚’ä¿å­˜</button>
      </div>

      </div>

      <div class="card" style="margin-top:16px">
        <div class="card-title">GASã‚³ãƒ¼ãƒ‰ï¼ˆã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ç”¨ï¼‰</div>
        <p style="font-size:13px; color:var(--text3); margin-bottom:12px">ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’GASã«ã‚³ãƒ”ãƒ¼ã—ã€ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã€ã—ã¦ãã ã•ã„ã€‚</p>
        <pre style="background:var(--bg3); padding:14px; border-radius:8px; font-family:'DM Mono',monospace; font-size:11px; color:var(--text2); overflow-x:auto; white-space:pre-wrap; line-height:1.6" id="gas-code-display"></pre>
        <button class="btn btn-ghost btn-sm" style="margin-top:10px" onclick="copyGasCode()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>

  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modal-contact">
  <div class="modal">
    <div class="modal-title">
      <span id="modal-contact-title">é¡§å®¢ã‚’è¿½åŠ </span>
      <button class="modal-close" onclick="closeModal('modal-contact')">âœ•</button>
    </div>
    <div class="form-group">
      <label class="form-label">ç¨®åˆ¥</label>
      <select class="form-select" id="contact-type" onchange="toggleCompanyField()">
        <option value="btoc">BtoCï¼ˆå€‹äººï¼‰</option>
        <option value="btob">BtoBï¼ˆæ³•äººï¼‰</option>
      </select>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">åå‰ *</label>
        <input class="form-input" id="contact-name" placeholder="ä¾‹ï¼šç”°ä¸­ å¤ªéƒ">
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ•ãƒªã‚¬ãƒŠ</label>
        <input class="form-input" id="contact-kana" placeholder="ã‚¿ãƒŠã‚« ã‚¿ãƒ­ã‚¦">
      </div>
    </div>
    <div class="form-group" id="company-field">
      <label class="form-label">ä¼šç¤¾å</label>
      <input class="form-input" id="contact-company" placeholder="æ ªå¼ä¼šç¤¾ã€‡ã€‡">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¼ãƒ«</label>
        <input class="form-input" id="contact-email" type="email" placeholder="example@email.com">
      </div>
      <div class="form-group">
        <label class="form-label">é›»è©±ç•ªå·</label>
        <input class="form-input" id="contact-phone" placeholder="090-0000-0000">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
        <select class="form-select" id="contact-status">
          <option value="lead">ãƒªãƒ¼ãƒ‰</option>
          <option value="prospect">è¦‹è¾¼ã¿</option>
          <option value="customer">é¡§å®¢</option>
          <option value="inactive">ä¼‘çœ </option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">æ‹…å½“è€…</label>
        <input class="form-input" id="contact-owner" placeholder="æ‹…å½“è€…å">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">ãƒ¡ãƒ¢</label>
      <textarea class="form-textarea" id="contact-memo" placeholder="å‚™è€ƒãƒ»ãƒ¡ãƒ¢"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-contact')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveContact()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-deal">
  <div class="modal">
    <div class="modal-title">
      <span id="modal-deal-title">å•†è«‡ã‚’è¿½åŠ </span>
      <button class="modal-close" onclick="closeModal('modal-deal')">âœ•</button>
    </div>
    <div class="form-group">
      <label class="form-label">å•†è«‡å *</label>
      <input class="form-input" id="deal-name" placeholder="ä¾‹ï¼šAãƒ—ãƒ©ãƒ³å°å…¥ææ¡ˆ">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">é¡§å®¢</label>
        <select class="form-select" id="deal-contact"></select>
      </div>
      <div class="form-group">
        <label class="form-label">é‡‘é¡ï¼ˆå††ï¼‰</label>
        <input class="form-input" id="deal-amount" type="number" placeholder="500000">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¸</label>
        <select class="form-select" id="deal-stage">
          <option value="lead">ãƒªãƒ¼ãƒ‰</option>
          <option value="proposal">ææ¡ˆä¸­</option>
          <option value="negotiation">äº¤æ¸‰ä¸­</option>
          <option value="won">å—æ³¨</option>
          <option value="lost">å¤±æ³¨</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">æˆç´„äºˆå®šæ—¥</label>
        <input class="form-input" id="deal-close-date" type="date">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">ç¢ºåº¦ï¼ˆ%ï¼‰</label>
      <input class="form-input" id="deal-probability" type="number" min="0" max="100" placeholder="50">
    </div>
    <div class="form-group">
      <label class="form-label">ãƒ¡ãƒ¢</label>
      <textarea class="form-textarea" id="deal-memo" placeholder="å•†è«‡ãƒ¡ãƒ¢"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-deal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveDeal()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-task">
  <div class="modal">
    <div class="modal-title">
      <span>ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </span>
      <button class="modal-close" onclick="closeModal('modal-task')">âœ•</button>
    </div>
    <div class="form-group">
      <label class="form-label">ã‚¿ã‚¹ã‚¯å *</label>
      <input class="form-input" id="task-name" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›...">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">é–¢é€£é¡§å®¢</label>
        <select class="form-select" id="task-contact">
          <option value="">ãªã—</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">å„ªå…ˆåº¦</label>
        <select class="form-select" id="task-priority">
          <option value="low">ä½</option>
          <option value="medium">ä¸­</option>
          <option value="high">é«˜</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">æœŸé™</label>
        <input class="form-input" id="task-due" type="date">
      </div>
      <div class="form-group">
        <label class="form-label">æ‹…å½“è€…</label>
        <input class="form-input" id="task-owner" placeholder="æ‹…å½“è€…å">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">ãƒ¡ãƒ¢</label>
      <textarea class="form-textarea" id="task-memo" placeholder="è©³ç´°ãƒ¡ãƒ¢"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-task')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveTask()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-activity">
  <div class="modal">
    <div class="modal-title">
      <span>æ´»å‹•ã‚’è¨˜éŒ²</span>
      <button class="modal-close" onclick="closeModal('modal-activity')">âœ•</button>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">ç¨®åˆ¥</label>
        <select class="form-select" id="activity-type">
          <option value="call">ğŸ“ é›»è©±</option>
          <option value="email">ğŸ“§ ãƒ¡ãƒ¼ãƒ«</option>
          <option value="meeting">ğŸ¤ è¨ªå•ãƒ»æ‰“åˆã›</option>
          <option value="note">ğŸ“ ãƒ¡ãƒ¢</option>
          <option value="other">ãã®ä»–</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">é¡§å®¢</label>
        <select class="form-select" id="activity-contact">
          <option value="">ãªã—</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">å†…å®¹ *</label>
      <textarea class="form-textarea" id="activity-content" placeholder="æ´»å‹•å†…å®¹ã‚’å…¥åŠ›..."></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">æ—¥æ™‚</label>
        <input class="form-input" id="activity-date" type="datetime-local">
      </div>
      <div class="form-group">
        <label class="form-label">æ‹…å½“è€…</label>
        <input class="form-input" id="activity-owner" placeholder="æ‹…å½“è€…å">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-activity')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveActivity()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- DETAIL PANEL -->
<div class="detail-overlay" id="detail-overlay">
  <div class="detail-bg" onclick="closeDetail()"></div>
  <div class="detail-panel" id="detail-panel">
    <div id="detail-content"></div>
  </div>
</div>

<script>
// ============================================================
//  DATA STORE (LocalStorage + GAS sync)
// ============================================================
let db = {
  contacts: [],
  deals: [],
  tasks: [],
  activities: []
};

let gasUrl = localStorage.getItem('crm_gas_url') || '';
let currentContactFilter = 'all';
let currentTaskFilter = 'all';
let editingId = null;

// ============================================================
//  AUTH - Google Sign-In
// ============================================================
let currentUser = null;
let authConfig = {
  clientId: localStorage.getItem('crm_client_id') || '',
  allowedDomain: localStorage.getItem('crm_allowed_domain') || ''
};

function initAuth() {
  // è¨­å®šç”»é¢ã«æ—¢å­˜å€¤ã‚’åæ˜ 
  if (authConfig.clientId) document.getElementById('google-client-id').value = authConfig.clientId;
  if (authConfig.allowedDomain) {
    document.getElementById('allowed-domain').value = authConfig.allowedDomain;
    document.getElementById('login-domain-info').textContent = 'è¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼š' + authConfig.allowedDomain;
  }

  // æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
  const saved = sessionStorage.getItem('crm_user');
  if (saved) {
    currentUser = JSON.parse(saved);
    onLoginSuccess(currentUser);
    return;
  }

  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDãŒæœªè¨­å®šã®å ´åˆã¯è¨­å®šç”»é¢ã¸èª˜å°
  if (!authConfig.clientId) {
    showConfigWarning();
    return;
  }

  showLoginScreen();
}

function showLoginScreen() {
  document.getElementById('login-screen').classList.add('show');
  document.body.style.overflow = 'hidden';

  // Google Sign-In ãƒœã‚¿ãƒ³åˆæœŸåŒ–
  if (window.google && authConfig.clientId) {
    google.accounts.id.initialize({
      client_id: authConfig.clientId,
      callback: handleGoogleCredential,
      auto_select: false,
    });
    google.accounts.id.renderButton(
      document.getElementById('google-signin-btn'),
      {
        theme: 'filled_black',
        size: 'large',
        width: 280,
        text: 'signin_with',
        locale: 'ja'
      }
    );
  } else {
    // Google GSIã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆ
    setTimeout(showLoginScreen, 500);
  }
}

function handleGoogleCredential(response) {
  const payload = parseJwt(response.credential);
  const email = payload.email || '';
  const domain = email.split('@')[1] || '';

  // ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
  if (authConfig.allowedDomain && domain !== authConfig.allowedDomain) {
    document.getElementById('login-error').style.display = 'block';
    return;
  }

  const user = {
    name: payload.name,
    email: payload.email,
    picture: payload.picture,
    initial: (payload.name || payload.email).charAt(0).toUpperCase()
  };

  sessionStorage.setItem('crm_user', JSON.stringify(user));
  onLoginSuccess(user);
}

function onLoginSuccess(user) {
  currentUser = user;
  document.getElementById('login-screen').classList.remove('show');
  document.body.style.overflow = '';

  // ã‚¢ãƒã‚¿ãƒ¼æ›´æ–°
  const btn = document.getElementById('user-avatar-btn');
  if (user.picture) {
    btn.innerHTML = `<img src="${user.picture}" style="width:30px;height:30px;border-radius:50%;object-fit:cover">`;
  } else {
    btn.textContent = user.initial;
  }
  document.getElementById('user-menu-name').textContent = user.name || '';
  document.getElementById('user-menu-email').textContent = user.email || '';
}

function showConfigWarning() {
  // èªè¨¼æœªè¨­å®šã®å ´åˆã¯ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
  document.getElementById('login-screen').classList.remove('show');
  const banner = document.createElement('div');
  banner.className = 'config-banner show';
  banner.innerHTML = `âš ï¸ <strong>èªè¨¼æœªè¨­å®šï¼šãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰</strong>ã€€è¨­å®šç”»é¢ã§Googleã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨è¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚`;
  document.querySelector('.content').prepend(banner);

  // ãƒ€ãƒŸãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼
  onLoginSuccess({ name: 'ãƒ‡ãƒ¢ãƒ¦ãƒ¼ã‚¶ãƒ¼', email: 'demo@example.com', initial: 'D' });
}

function logout() {
  sessionStorage.removeItem('crm_user');
  currentUser = null;
  if (window.google && authConfig.clientId) {
    google.accounts.id.disableAutoSelect();
  }
  location.reload();
}

function toggleUserMenu() {
  document.getElementById('user-menu').classList.toggle('show');
}

function saveAuthConfig() {
  authConfig.clientId = document.getElementById('google-client-id').value.trim();
  authConfig.allowedDomain = document.getElementById('allowed-domain').value.trim();
  localStorage.setItem('crm_client_id', authConfig.clientId);
  localStorage.setItem('crm_allowed_domain', authConfig.allowedDomain);
  alert('èªè¨¼è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  location.reload();
}

function parseJwt(token) {
  const base64 = token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
  return JSON.parse(decodeURIComponent(atob(base64).split('').map(c =>
    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
  ).join('')));
}

// å¤–ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
document.addEventListener('click', e => {
  const menu = document.getElementById('user-menu');
  const btn = document.getElementById('user-avatar-btn');
  if (menu && !menu.contains(e.target) && e.target !== btn) {
    menu.classList.remove('show');
  }
});

// ============================================================
//  INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  loadFromStorage();
  initAuth();
  if (gasUrl) {
    document.getElementById('gas-url').value = gasUrl;
    syncFromGas();
  } else {
    loadDemoData();
  }
  renderAll();
  setGasCodeDisplay();

  // Set default datetime
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  const local = now.toISOString().slice(0, 16);
  document.getElementById('activity-date').value = local;
  document.getElementById('task-due').value = now.toISOString().slice(0, 10);
});

function loadFromStorage() {
  ['contacts','deals','tasks','activities'].forEach(k => {
    const s = localStorage.getItem('crm_' + k);
    if (s) db[k] = JSON.parse(s);
  });
}

function saveToStorage() {
  ['contacts','deals','tasks','activities'].forEach(k => {
    localStorage.setItem('crm_' + k, JSON.stringify(db[k]));
  });
}

function loadDemoData() {
  if (db.contacts.length > 0) return;
  const now = new Date().toISOString();
  db.contacts = [
    { id:'c1', type:'btob', name:'å±±ç”° èŠ±å­', kana:'ãƒ¤ãƒãƒ€ ãƒãƒŠã‚³', company:'æ ªå¼ä¼šç¤¾å±±ç”°å•†äº‹', email:'yamada@example.com', phone:'03-1234-5678', status:'customer', owner:'éˆ´æœ¨', memo:'é‡è¦é¡§å®¢', createdAt:now },
    { id:'c2', type:'btoc', name:'ç”°ä¸­ æ¬¡éƒ', kana:'ã‚¿ãƒŠã‚« ã‚¸ãƒ­ã‚¦', company:'', email:'tanaka@example.com', phone:'090-1111-2222', status:'prospect', owner:'ä½è—¤', memo:'', createdAt:now },
    { id:'c3', type:'btob', name:'å°æ— å¥', kana:'ã‚³ãƒãƒ¤ã‚· ã‚¿ã‚±ãƒ«', company:'å°æ—å·¥æ¥­æ ªå¼ä¼šç¤¾', email:'kobayashi@example.com', phone:'06-9999-0000', status:'lead', owner:'éˆ´æœ¨', memo:'å±•ç¤ºä¼šã§ååˆºäº¤æ›', createdAt:now },
    { id:'c4', type:'btoc', name:'éˆ´æœ¨ ã¿ã‹', kana:'ã‚¹ã‚ºã‚­ ãƒŸã‚«', company:'', email:'suzuki@example.com', phone:'080-3333-4444', status:'customer', owner:'ç”°ä¸­', memo:'', createdAt:now },
  ];
  db.deals = [
    { id:'d1', name:'Aãƒ—ãƒ©ãƒ³å°å…¥ææ¡ˆ', contactId:'c1', amount:1200000, stage:'proposal', closeDate:'2026-03-31', probability:60, memo:'', createdAt:now },
    { id:'d2', name:'åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸', contactId:'c2', amount:350000, stage:'negotiation', closeDate:'2026-02-28', probability:75, memo:'', createdAt:now },
    { id:'d3', name:'è¨­å‚™ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å¥‘ç´„', contactId:'c3', amount:800000, stage:'lead', closeDate:'2026-04-30', probability:20, memo:'', createdAt:now },
    { id:'d4', name:'ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ãƒ—ãƒ©ãƒ³', contactId:'c4', amount:500000, stage:'won', closeDate:'2026-01-31', probability:100, memo:'', createdAt:now },
  ];
  db.tasks = [
    { id:'t1', name:'è¦‹ç©æ›¸é€ä»˜', contactId:'c1', priority:'high', dueDate:'2026-02-25', done:false, owner:'éˆ´æœ¨', memo:'', createdAt:now },
    { id:'t2', name:'é›»è©±ãƒ•ã‚©ãƒ­ãƒ¼', contactId:'c2', priority:'medium', dueDate:'2026-02-28', done:false, owner:'ä½è—¤', memo:'', createdAt:now },
    { id:'t3', name:'ç¾åœ°èª¿æŸ»', contactId:'c3', priority:'low', dueDate:'2026-03-05', done:false, owner:'éˆ´æœ¨', memo:'', createdAt:now },
    { id:'t4', name:'å¥‘ç´„æ›¸ç¢ºèª', contactId:'c4', priority:'high', dueDate:'2026-01-15', done:true, owner:'ç”°ä¸­', memo:'', createdAt:now },
  ];
  db.activities = [
    { id:'a1', type:'meeting', contactId:'c1', content:'æ–°ã‚·ã‚¹ãƒ†ãƒ å°å…¥ã«ã¤ã„ã¦ãƒ’ã‚¢ãƒªãƒ³ã‚°ã€‚æ¥é€±è¦‹ç©ã‚‚ã‚Šæå‡ºäºˆå®šã€‚', date:'2026-02-22T10:00', owner:'éˆ´æœ¨', createdAt:now },
    { id:'a2', type:'call', contactId:'c2', content:'åˆå›ã‚³ãƒ³ã‚¿ã‚¯ãƒˆã€‚èˆˆå‘³ã‚ã‚Šã€è³‡æ–™é€ä»˜æ¸ˆã¿ã€‚', date:'2026-02-21T14:30', owner:'ä½è—¤', createdAt:now },
    { id:'a3', type:'email', contactId:'c3', content:'å±•ç¤ºä¼šãŠç¤¼ãƒ¡ãƒ¼ãƒ«é€ä»˜ã€‚è£½å“ã‚«ã‚¿ãƒ­ã‚°åŒå°ã€‚', date:'2026-02-20T09:00', owner:'éˆ´æœ¨', createdAt:now },
  ];
  saveToStorage();
}

// ============================================================
//  NAVIGATION
// ============================================================
const pageTitles = {
  dashboard: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
  contacts: 'é¡§å®¢ç®¡ç†',
  deals: 'å•†è«‡ç®¡ç†',
  tasks: 'ã‚¿ã‚¹ã‚¯',
  activities: 'æ´»å‹•å±¥æ­´',
  settings: 'è¨­å®š'
};

const pageActions = {
  dashboard: '',
  contacts: '<button class="btn btn-primary btn-sm" onclick="openContactModal()">ï¼‹ é¡§å®¢è¿½åŠ </button>',
  deals: '<button class="btn btn-primary btn-sm" onclick="openDealModal()">ï¼‹ å•†è«‡è¿½åŠ </button>',
  tasks: '<button class="btn btn-primary btn-sm" onclick="openTaskModal()">ï¼‹ ã‚¿ã‚¹ã‚¯è¿½åŠ </button>',
  activities: '<button class="btn btn-primary btn-sm" onclick="openActivityModal()">ï¼‹ æ´»å‹•è¨˜éŒ²</button>',
  settings: ''
};

function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.querySelector(`[data-page="${name}"]`).classList.add('active');
  document.getElementById('page-title').textContent = pageTitles[name];
  document.getElementById('topbar-actions').innerHTML = pageActions[name] || '';
}

// ============================================================
//  RENDER ALL
// ============================================================
function renderAll() {
  renderDashboard();
  renderContacts();
  renderKanban();
  renderTasks();
  renderActivities();
}

// ============================================================
//  DASHBOARD
// ============================================================
function renderDashboard() {
  const activeDealCount = db.deals.filter(d => !['won','lost'].includes(d.stage)).length;
  const revenue = db.deals.filter(d => d.stage === 'won').reduce((s,d) => s + (d.amount||0), 0);
  const pendingTasks = db.tasks.filter(t => !t.done).length;

  document.getElementById('stat-contacts').textContent = db.contacts.length;
  document.getElementById('stat-deals').textContent = activeDealCount;
  document.getElementById('stat-revenue').textContent = 'Â¥' + revenue.toLocaleString();
  document.getElementById('stat-tasks').textContent = pendingTasks;

  // Funnel
  const stages = [
    { key:'lead', label:'ãƒªãƒ¼ãƒ‰', color:'#6366f1' },
    { key:'proposal', label:'ææ¡ˆä¸­', color:'#3b82f6' },
    { key:'negotiation', label:'äº¤æ¸‰ä¸­', color:'#f59e0b' },
    { key:'won', label:'å—æ³¨', color:'#10b981' },
  ];
  const total = db.deals.length || 1;
  const funnelHtml = stages.map(s => {
    const cnt = db.deals.filter(d => d.stage === s.key).length;
    const pct = Math.round(cnt / total * 100);
    return `<div class="funnel-item">
      <span class="funnel-label">${s.label}</span>
      <div class="funnel-bar-wrap"><div class="funnel-bar" style="width:${pct}%;background:${s.color}"></div></div>
      <span class="funnel-count">${cnt}</span>
    </div>`;
  }).join('');
  document.getElementById('funnel-chart').innerHTML = funnelHtml || '<div style="color:var(--text3);font-size:13px">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';

  // Tasks
  const upcomingTasks = db.tasks.filter(t => !t.done).slice(0, 5);
  const today = new Date().toISOString().slice(0,10);
  const taskHtml = upcomingTasks.length ? upcomingTasks.map(t => {
    const contact = db.contacts.find(c => c.id === t.contactId);
    const overdue = t.dueDate && t.dueDate < today;
    return `<div class="task-item">
      <div class="task-check ${t.done?'done':''}" onclick="toggleTask('${t.id}')">âœ“</div>
      <div class="task-text">${t.name}${contact?` <span style="color:var(--text3)">ãƒ»${contact.name}</span>`:''}
      </div>
      <div class="task-due ${overdue?'overdue':''}">${t.dueDate||''}</div>
    </div>`;
  }).join('') : '<div style="color:var(--text3);font-size:13px;padding:12px 0">ã‚¿ã‚¹ã‚¯ãªã—</div>';
  document.getElementById('dashboard-tasks').innerHTML = taskHtml;

  // Activities
  const recentActs = [...db.activities].sort((a,b) => b.date.localeCompare(a.date)).slice(0,5);
  const typeEmoji = { call:'ğŸ“', email:'ğŸ“§', meeting:'ğŸ¤', note:'ğŸ“', other:'ğŸ“Œ' };
  const actHtml = recentActs.length ? recentActs.map(a => {
    const contact = db.contacts.find(c => c.id === a.contactId);
    return `<div class="activity-item">
      <div class="activity-dot"></div>
      <div>
        <div class="activity-text">${typeEmoji[a.type]||'ğŸ“Œ'} ${contact?`<strong>${contact.name}</strong> `:''} ${a.content}</div>
        <div class="activity-time">${formatDate(a.date)} ${a.owner?'ãƒ»'+a.owner:''}</div>
      </div>
    </div>`;
  }).join('') : '<div style="color:var(--text3);font-size:13px;padding:12px 0">æ´»å‹•ãªã—</div>';
  document.getElementById('dashboard-activities').innerHTML = actHtml;
}

// ============================================================
//  CONTACTS
// ============================================================
function renderContacts(filter) {
  let contacts = db.contacts;
  const q = document.getElementById('contact-search')?.value.toLowerCase() || '';
  if (currentContactFilter !== 'all') contacts = contacts.filter(c => c.type === currentContactFilter);
  if (q) contacts = contacts.filter(c =>
    c.name.toLowerCase().includes(q) ||
    (c.company||'').toLowerCase().includes(q) ||
    (c.email||'').toLowerCase().includes(q)
  );

  const statusMap = {
    lead: ['ãƒªãƒ¼ãƒ‰','badge-blue'],
    prospect: ['è¦‹è¾¼ã¿','badge-purple'],
    customer: ['é¡§å®¢','badge-green'],
    inactive: ['ä¼‘çœ ','badge-gray']
  };

  const tbody = document.getElementById('contacts-tbody');
  if (!contacts.length) {
    tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="emoji">ğŸ‘¥</div><p>é¡§å®¢ãŒã„ã¾ã›ã‚“</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML = contacts.map(c => {
    const [sl, sc] = statusMap[c.status] || ['ä¸æ˜','badge-gray'];
    return `<tr onclick="showContactDetail('${c.id}')" style="cursor:pointer">
      <td><span class="link-text">${c.name}</span></td>
      <td><span class="badge ${c.type==='btob'?'badge-blue':'badge-purple'}">${c.type==='btob'?'æ³•äºº':'å€‹äºº'}</span></td>
      <td class="hide-mobile">${c.company||'â€”'}</td>
      <td class="hide-mobile">${c.email||'â€”'}</td>
      <td><span class="badge ${sc}">${sl}</span></td>
      <td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();editContact('${c.id}')">ç·¨é›†</button></td>
    </tr>`;
  }).join('');
}

function setContactFilter(f, el) {
  currentContactFilter = f;
  document.querySelectorAll('#page-contacts .filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderContacts();
}

function filterContacts() { renderContacts(); }

// ============================================================
//  KANBAN (DEALS)
// ============================================================
const stages = [
  { key:'lead', label:'ãƒªãƒ¼ãƒ‰', color:'#6366f1' },
  { key:'proposal', label:'ææ¡ˆä¸­', color:'#3b82f6' },
  { key:'negotiation', label:'äº¤æ¸‰ä¸­', color:'#f59e0b' },
  { key:'won', label:'å—æ³¨ ğŸ‰', color:'#10b981' },
  { key:'lost', label:'å¤±æ³¨', color:'#ef4444' },
];

function renderKanban() {
  const board = document.getElementById('kanban-board');
  board.innerHTML = stages.map(s => {
    const deals = db.deals.filter(d => d.stage === s.key);
    const cards = deals.map(d => {
      const contact = db.contacts.find(c => c.id === d.contactId);
      return `<div class="deal-card" onclick="showDealDetail('${d.id}')">
        <div class="deal-name">${d.name}</div>
        <div class="deal-customer">${contact ? contact.name : 'â€”'}</div>
        <div class="deal-amount">Â¥${(d.amount||0).toLocaleString()}</div>
        <div class="deal-meta">
          <span>${d.probability||0}%</span>
          <span>${d.closeDate||''}</span>
        </div>
      </div>`;
    }).join('');
    return `<div class="kanban-col">
      <div class="kanban-col-title">
        <span style="color:${s.color}">${s.label}</span>
        <span class="kanban-col-count">${deals.length}</span>
      </div>
      ${cards || '<div style="color:var(--text3);font-size:12px;text-align:center;padding:16px 0">ãªã—</div>'}
    </div>`;
  }).join('');
}

// ============================================================
//  TASKS
// ============================================================
function renderTasks() {
  let tasks = db.tasks;
  const q = document.getElementById('task-search')?.value.toLowerCase() || '';
  if (currentTaskFilter === 'pending') tasks = tasks.filter(t => !t.done);
  if (currentTaskFilter === 'done') tasks = tasks.filter(t => t.done);
  if (q) tasks = tasks.filter(t => t.name.toLowerCase().includes(q));

  const today = new Date().toISOString().slice(0,10);
  const prioMap = { high:['é«˜','badge-red'], medium:['ä¸­','badge-yellow'], low:['ä½','badge-gray'] };
  const tbody = document.getElementById('tasks-tbody');
  if (!tasks.length) {
    tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="emoji">âœ…</div><p>ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML = tasks.map(t => {
    const contact = db.contacts.find(c => c.id === t.contactId);
    const overdue = t.dueDate && t.dueDate < today && !t.done;
    const [pl, pc] = prioMap[t.priority] || ['â€”','badge-gray'];
    return `<tr>
      <td><div class="task-check ${t.done?'done':''}" onclick="toggleTask('${t.id}')">âœ“</div></td>
      <td><span class="${t.done?'':'link-text'}" style="${t.done?'text-decoration:line-through;color:var(--text3)':''}">${t.name}</span></td>
      <td class="hide-mobile">${contact ? contact.name : 'â€”'}</td>
      <td><span class="${overdue?'badge badge-red':''}">${t.dueDate||'â€”'}</span></td>
      <td><span class="badge ${pc}">${pl}</span></td>
      <td><button class="btn btn-ghost btn-sm" onclick="deleteItem('tasks','${t.id}')">å‰Šé™¤</button></td>
    </tr>`;
  }).join('');
}

function setTaskFilter(f, el) {
  currentTaskFilter = f;
  document.querySelectorAll('#page-tasks .filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderTasks();
}

function filterTasks() { renderTasks(); }

function toggleTask(id) {
  const task = db.tasks.find(t => t.id === id);
  if (task) {
    task.done = !task.done;
    saveToStorage();
    renderAll();
    syncToGas('tasks', task);
  }
}

// ============================================================
//  ACTIVITIES
// ============================================================
function renderActivities() {
  const typeEmoji = { call:'ğŸ“ é›»è©±', email:'ğŸ“§ ãƒ¡ãƒ¼ãƒ«', meeting:'ğŸ¤ æ‰“åˆã›', note:'ğŸ“ ãƒ¡ãƒ¢', other:'ğŸ“Œ ãã®ä»–' };
  const tbody = document.getElementById('activities-tbody');
  const acts = [...db.activities].sort((a,b) => b.date.localeCompare(a.date));
  if (!acts.length) {
    tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><div class="emoji">ğŸ“‹</div><p>æ´»å‹•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML = acts.map(a => {
    const contact = db.contacts.find(c => c.id === a.contactId);
    return `<tr>
      <td style="white-space:nowrap">${formatDate(a.date)}</td>
      <td>${typeEmoji[a.type]||a.type}</td>
      <td>${contact ? contact.name : 'â€”'}</td>
      <td class="hide-mobile" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${a.content}</td>
      <td class="hide-mobile">${a.owner||'â€”'}</td>
    </tr>`;
  }).join('');
}

// ============================================================
//  DETAIL PANELS
// ============================================================
function showContactDetail(id) {
  const c = db.contacts.find(x => x.id === id);
  if (!c) return;
  const deals = db.deals.filter(d => d.contactId === id);
  const tasks = db.tasks.filter(t => t.contactId === id && !t.done);
  const acts = db.activities.filter(a => a.contactId === id);

  const statusMap = { lead:'ãƒªãƒ¼ãƒ‰', prospect:'è¦‹è¾¼ã¿', customer:'é¡§å®¢', inactive:'ä¼‘çœ ' };

  document.getElementById('detail-content').innerHTML = `
    <div class="detail-header">
      <div class="detail-avatar">${c.type==='btob'?'ğŸ¢':'ğŸ‘¤'}</div>
      <div>
        <div class="detail-name">${c.name}</div>
        <div class="detail-sub">${c.type==='btob'?'æ³•äºº':'å€‹äºº'}${c.company?' ãƒ» '+c.company:''}</div>
      </div>
      <button class="modal-close detail-close" onclick="closeDetail()">âœ•</button>
    </div>
    <div class="detail-body">
      <div class="detail-section">
        <div class="detail-section-title">åŸºæœ¬æƒ…å ±</div>
        ${field('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', statusMap[c.status]||c.status)}
        ${field('ãƒ¡ãƒ¼ãƒ«', c.email||'â€”')}
        ${field('é›»è©±', c.phone||'â€”')}
        ${field('æ‹…å½“è€…', c.owner||'â€”')}
        ${c.memo ? field('ãƒ¡ãƒ¢', c.memo) : ''}
      </div>
      ${deals.length ? `<div class="detail-section">
        <div class="detail-section-title">é–¢é€£å•†è«‡ (${deals.length})</div>
        ${deals.map(d => `<div class="task-item"><span class="link-text" onclick="showDealDetail('${d.id}')">${d.name}</span><span style="font-family:'DM Mono',monospace;font-size:12px">Â¥${(d.amount||0).toLocaleString()}</span></div>`).join('')}
      </div>` : ''}
      ${tasks.length ? `<div class="detail-section">
        <div class="detail-section-title">æœªå®Œäº†ã‚¿ã‚¹ã‚¯ (${tasks.length})</div>
        ${tasks.map(t => `<div class="task-item"><div class="task-check" onclick="toggleTask('${t.id}')">âœ“</div><span>${t.name}</span><span class="task-due">${t.dueDate||''}</span></div>`).join('')}
      </div>` : ''}
      ${acts.length ? `<div class="detail-section">
        <div class="detail-section-title">æ´»å‹•å±¥æ­´ (${acts.length})</div>
        ${acts.slice(0,5).map(a => `<div class="activity-item"><div class="activity-dot"></div><div><div class="activity-text">${a.content}</div><div class="activity-time">${formatDate(a.date)}</div></div></div>`).join('')}
      </div>` : ''}
      <div style="display:flex;gap:8px;margin-top:16px">
        <button class="btn btn-ghost btn-sm" onclick="editContact('${c.id}');closeDetail()">ç·¨é›†</button>
        <button class="btn btn-danger btn-sm" onclick="deleteItem('contacts','${c.id}');closeDetail()">å‰Šé™¤</button>
      </div>
    </div>
  `;
  document.getElementById('detail-overlay').classList.add('show');
}

function showDealDetail(id) {
  const d = db.deals.find(x => x.id === id);
  if (!d) return;
  const contact = db.contacts.find(c => c.id === d.contactId);
  const stageLabel = stages.find(s => s.key === d.stage)?.label || d.stage;
  document.getElementById('detail-content').innerHTML = `
    <div class="detail-header">
      <div class="detail-avatar">ğŸ’¼</div>
      <div>
        <div class="detail-name">${d.name}</div>
        <div class="detail-sub">${contact ? contact.name : 'â€”'}</div>
      </div>
      <button class="modal-close detail-close" onclick="closeDetail()">âœ•</button>
    </div>
    <div class="detail-body">
      <div class="detail-section">
        <div class="detail-section-title">å•†è«‡æƒ…å ±</div>
        ${field('é‡‘é¡', 'Â¥' + (d.amount||0).toLocaleString())}
        ${field('ã‚¹ãƒ†ãƒ¼ã‚¸', stageLabel)}
        ${field('ç¢ºåº¦', (d.probability||0) + '%')}
        ${field('æˆç´„äºˆå®šæ—¥', d.closeDate||'â€”')}
        ${field('é¡§å®¢', contact ? contact.name : 'â€”')}
        ${d.memo ? field('ãƒ¡ãƒ¢', d.memo) : ''}
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button class="btn btn-ghost btn-sm" onclick="editDeal('${d.id}');closeDetail()">ç·¨é›†</button>
        <button class="btn btn-danger btn-sm" onclick="deleteItem('deals','${d.id}');closeDetail()">å‰Šé™¤</button>
      </div>
    </div>
  `;
  document.getElementById('detail-overlay').classList.add('show');
}

function field(label, value) {
  return `<div class="detail-field"><span class="detail-field-label">${label}</span><span class="detail-field-value">${value}</span></div>`;
}

function closeDetail() {
  document.getElementById('detail-overlay').classList.remove('show');
}

// ============================================================
//  MODALS
// ============================================================
function openContactModal() {
  editingId = null;
  document.getElementById('modal-contact-title').textContent = 'é¡§å®¢ã‚’è¿½åŠ ';
  ['contact-name','contact-kana','contact-company','contact-email','contact-phone','contact-owner','contact-memo'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('contact-type').value = 'btoc';
  document.getElementById('contact-status').value = 'lead';
  toggleCompanyField();
  document.getElementById('modal-contact').classList.add('show');
}

function editContact(id) {
  const c = db.contacts.find(x => x.id === id);
  if (!c) return;
  editingId = id;
  document.getElementById('modal-contact-title').textContent = 'é¡§å®¢ã‚’ç·¨é›†';
  document.getElementById('contact-type').value = c.type;
  document.getElementById('contact-name').value = c.name;
  document.getElementById('contact-kana').value = c.kana || '';
  document.getElementById('contact-company').value = c.company || '';
  document.getElementById('contact-email').value = c.email || '';
  document.getElementById('contact-phone').value = c.phone || '';
  document.getElementById('contact-status').value = c.status;
  document.getElementById('contact-owner').value = c.owner || '';
  document.getElementById('contact-memo').value = c.memo || '';
  toggleCompanyField();
  document.getElementById('modal-contact').classList.add('show');
}

function saveContact() {
  const name = document.getElementById('contact-name').value.trim();
  if (!name) { alert('åå‰ã¯å¿…é ˆã§ã™'); return; }
  const data = {
    type: document.getElementById('contact-type').value,
    name, kana: document.getElementById('contact-kana').value,
    company: document.getElementById('contact-company').value,
    email: document.getElementById('contact-email').value,
    phone: document.getElementById('contact-phone').value,
    status: document.getElementById('contact-status').value,
    owner: document.getElementById('contact-owner').value,
    memo: document.getElementById('contact-memo').value,
  };
  if (editingId) {
    Object.assign(db.contacts.find(c => c.id === editingId), data);
  } else {
    data.id = 'c' + Date.now();
    data.createdAt = new Date().toISOString();
    db.contacts.push(data);
  }
  saveToStorage();
  renderAll();
  closeModal('modal-contact');
  syncToGas('contacts', data);
}

function toggleCompanyField() {
  const type = document.getElementById('contact-type').value;
  document.getElementById('company-field').style.display = type === 'btob' ? 'block' : 'none';
}

function openDealModal() {
  editingId = null;
  document.getElementById('modal-deal-title').textContent = 'å•†è«‡ã‚’è¿½åŠ ';
  ['deal-name','deal-amount','deal-memo'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('deal-stage').value = 'proposal';
  document.getElementById('deal-probability').value = '50';
  document.getElementById('deal-close-date').value = '';
  populateContactSelect('deal-contact');
  document.getElementById('modal-deal').classList.add('show');
}

function editDeal(id) {
  const d = db.deals.find(x => x.id === id);
  if (!d) return;
  editingId = id;
  document.getElementById('modal-deal-title').textContent = 'å•†è«‡ã‚’ç·¨é›†';
  populateContactSelect('deal-contact', d.contactId);
  document.getElementById('deal-name').value = d.name;
  document.getElementById('deal-amount').value = d.amount || '';
  document.getElementById('deal-stage').value = d.stage;
  document.getElementById('deal-close-date').value = d.closeDate || '';
  document.getElementById('deal-probability').value = d.probability || 50;
  document.getElementById('deal-memo').value = d.memo || '';
  document.getElementById('modal-deal').classList.add('show');
}

function saveDeal() {
  const name = document.getElementById('deal-name').value.trim();
  if (!name) { alert('å•†è«‡åã¯å¿…é ˆã§ã™'); return; }
  const data = {
    name,
    contactId: document.getElementById('deal-contact').value,
    amount: parseInt(document.getElementById('deal-amount').value) || 0,
    stage: document.getElementById('deal-stage').value,
    closeDate: document.getElementById('deal-close-date').value,
    probability: parseInt(document.getElementById('deal-probability').value) || 0,
    memo: document.getElementById('deal-memo').value,
  };
  if (editingId) {
    Object.assign(db.deals.find(d => d.id === editingId), data);
  } else {
    data.id = 'd' + Date.now();
    data.createdAt = new Date().toISOString();
    db.deals.push(data);
  }
  saveToStorage();
  renderAll();
  closeModal('modal-deal');
  syncToGas('deals', data);
}

function openTaskModal() {
  ['task-name','task-owner','task-memo'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('task-priority').value = 'medium';
  document.getElementById('task-due').value = new Date().toISOString().slice(0,10);
  populateContactSelect('task-contact', null, true);
  document.getElementById('modal-task').classList.add('show');
}

function saveTask() {
  const name = document.getElementById('task-name').value.trim();
  if (!name) { alert('ã‚¿ã‚¹ã‚¯åã¯å¿…é ˆã§ã™'); return; }
  const data = {
    id: 't' + Date.now(),
    name,
    contactId: document.getElementById('task-contact').value,
    priority: document.getElementById('task-priority').value,
    dueDate: document.getElementById('task-due').value,
    owner: document.getElementById('task-owner').value,
    memo: document.getElementById('task-memo').value,
    done: false,
    createdAt: new Date().toISOString()
  };
  db.tasks.push(data);
  saveToStorage();
  renderAll();
  closeModal('modal-task');
  syncToGas('tasks', data);
}

function openActivityModal() {
  ['activity-content','activity-owner'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('activity-type').value = 'call';
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  document.getElementById('activity-date').value = now.toISOString().slice(0,16);
  populateContactSelect('activity-contact', null, true);
  document.getElementById('modal-activity').classList.add('show');
}

function saveActivity() {
  const content = document.getElementById('activity-content').value.trim();
  if (!content) { alert('å†…å®¹ã¯å¿…é ˆã§ã™'); return; }
  const data = {
    id: 'a' + Date.now(),
    type: document.getElementById('activity-type').value,
    contactId: document.getElementById('activity-contact').value,
    content,
    date: document.getElementById('activity-date').value,
    owner: document.getElementById('activity-owner').value,
    createdAt: new Date().toISOString()
  };
  db.activities.push(data);
  saveToStorage();
  renderAll();
  closeModal('modal-activity');
  syncToGas('activities', data);
}

function populateContactSelect(selectId, selectedId = null, includeNone = false) {
  const el = document.getElementById(selectId);
  const opts = includeNone ? '<option value="">ãªã—</option>' : '';
  el.innerHTML = opts + db.contacts.map(c =>
    `<option value="${c.id}" ${c.id === selectedId ? 'selected' : ''}>${c.name}</option>`
  ).join('');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
  editingId = null;
}

function deleteItem(collection, id) {
  if (!confirm('å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  db[collection] = db[collection].filter(x => x.id !== id);
  saveToStorage();
  renderAll();
}

// ============================================================
//  GAS SYNC
// ============================================================
function saveGasUrl() {
  gasUrl = document.getElementById('gas-url').value.trim();
  localStorage.setItem('crm_gas_url', gasUrl);
  alert('URLã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚GASã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚');
  syncFromGas();
}

async function syncFromGas() {
  if (!gasUrl) return;
  try {
    const res = await fetch(gasUrl + '?action=getAll');
    const data = await res.json();
    if (data.contacts) db.contacts = data.contacts;
    if (data.deals) db.deals = data.deals;
    if (data.tasks) db.tasks = data.tasks;
    if (data.activities) db.activities = data.activities;
    saveToStorage();
    renderAll();
  } catch (e) {
    console.log('GAS sync error:', e);
  }
}

async function syncToGas(sheet, record) {
  if (!gasUrl) return;
  try {
    await fetch(gasUrl, {
      method: 'POST',
      body: JSON.stringify({ sheet, record }),
      headers: { 'Content-Type': 'text/plain' }
    });
  } catch(e) { console.log('GAS write error', e); }
}

// ============================================================
//  SETTINGS - GAS CODE
// ============================================================
function setGasCodeDisplay() {
  const code = `// CRM Pro - GAS ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
// ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã€ŒContactsã€ã€ŒDealsã€ã€ŒTasksã€ã€ŒActivitiesã€ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„

const SHEETS = ['Contacts', 'Deals', 'Tasks', 'Activities'];
const HEADERS = {
  Contacts: ['id','type','name','kana','company','email','phone','status','owner','memo','createdAt'],
  Deals: ['id','name','contactId','amount','stage','closeDate','probability','memo','createdAt'],
  Tasks: ['id','name','contactId','priority','dueDate','done','owner','memo','createdAt'],
  Activities: ['id','type','contactId','content','date','owner','createdAt']
};

function doGet(e) {
  const action = e.parameter.action;
  if (action === 'getAll') {
    const result = {};
    SHEETS.forEach(name => {
      result[name.toLowerCase()] = getSheetData(name);
    });
    return json(result);
  }
  return json({ error: 'unknown action' });
}

function doPost(e) {
  const body = JSON.parse(e.postData.contents);
  const sheetName = capitalize(body.sheet);
  const record = body.record;
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  if (!sheet) return json({ error: 'sheet not found' });

  const headers = HEADERS[sheetName];
  const existing = getSheetData(sheetName);
  const idx = existing.findIndex(r => r.id === record.id);

  if (idx >= 0) {
    // Update
    const row = idx + 2;
    headers.forEach((h, i) => {
      sheet.getRange(row, i + 1).setValue(record[h] !== undefined ? record[h] : '');
    });
  } else {
    // Insert
    const row = headers.map(h => record[h] !== undefined ? record[h] : '');
    sheet.appendRow(row);
  }
  return json({ result: 'ok' });
}

function getSheetData(name) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    sheet.appendRow(HEADERS[name]);
    return [];
  }
  const data = sheet.getDataRange().getValues();
  if (data.length <= 1) return [];
  const headers = data[0];
  return data.slice(1).map(row => {
    const obj = {};
    headers.forEach((h, i) => obj[h] = row[i]);
    return obj;
  });
}

function json(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function capitalize(s) {
  return s.charAt(0).toUpperCase() + s.slice(1);
}`;
  document.getElementById('gas-code-display').textContent = code;
}

function copyGasCode() {
  const code = document.getElementById('gas-code-display').textContent;
  navigator.clipboard.writeText(code).then(() => alert('ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'));
}

// ============================================================
//  UTILS
// ============================================================
function formatDate(dt) {
  if (!dt) return '';
  const d = new Date(dt);
  return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}

// Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => {
    if (e.target === el) el.classList.remove('show');
  });
});
</script>
</body>
</html>
